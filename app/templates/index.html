{% extends 'base.html' %}
{% block title %}Accueil - TLC App{% endblock %}
{% block head %}
<style>
    .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn-tlc {
        padding: 10px 18px;
        background: #1976d2;
        color: #fff;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-tlc:hover { background: #125ea2; }
    .btn-tlc.active, .btn-tlc:active {
        background: #4caf50 !important;
        color: #fff;
        box-shadow: 0 0 0 2px #388e3c;
    }
</style>
{% endblock %}
{% block content %}
    <h1>Nouvelle analyse</h1>
    <div class="btn-row" id="éluant">
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Opiacé</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Général</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Cocaïne</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">THC</button>
    </div>
    <div class="btn-row" id="révélateur">
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">UV254</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">UV365</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Marquis-Mandelin</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Dragendorf</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Mecke</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Liebermann</button>
    </div>
    <div class="btn-row" id="action">
        <button class="btn-tlc" onclick="saveData()">Sauvegarder</button>
        <button class="btn-tlc">Passer</button>
    </div>
    {% if last_img %}
        <div style="margin-bottom:30px;">
            <img src="{{ url_for('static', filename='images/' + last_img) }}" alt="Dernière image" style="max-width:400px; border:2px solid #4caf50; box-shadow:2px 2px 12px #aaa;">
            <br><b>{{ last_img }}</b>
        </div>
    {% else %}
        <p>Aucune image détectée.</p>
    {% endif %}
    <script>
        function selectBtn(btn, rowId) {
            const row = document.getElementById(rowId);
            Array.from(row.getElementsByClassName('btn-tlc')).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Sauvegarde le choix dans le localStorage
            localStorage.setItem('activeBtn_' + rowId, Array.from(row.children).indexOf(btn));
        }
        function restoreActiveBtns() {
            ['éluant', 'révélateur'].forEach(function(rowId) {
                const idx = localStorage.getItem('activeBtn_' + rowId);
                if (idx !== null) {
                    const row = document.getElementById(rowId);
                    if (row && row.children[idx]) {
                        row.children[idx].classList.add('active');
                    }
                }
            });
        }
        setTimeout(restoreActiveBtns, 100);
        function saveData() {
            const eluant = document.querySelector('#éluant .btn-tlc.active');
            const colorant = document.querySelector('#révélateur .btn-tlc.active');
            const file = {{ last_img|tojson|safe }};
            if (!file || !eluant || !colorant) {
                alert('Veuillez sélectionner un éluant, un révélateur et avoir une image.');
                return;
            }
            const dataToSave = { file: file, exp: [eluant.textContent, colorant.textContent] };
            alert('Données à sauvegarder :\n' + JSON.stringify(dataToSave, null, 2));
            fetch('/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            })
            .then(r => r.ok ? alert('Sauvegardé !') : alert('Erreur sauvegarde'));
        }
    </script>
{% endblock %}
