{% extends 'base.html' %}
{% block title %}Accueil - TLC App{% endblock %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
{% endblock %}
{% block content %}
    <div id="notif" class="notif"></div>
    <h1>Nouvelle analyse</h1>
    <div class="btn-row" id="éluant">
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Opiacé</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Général</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">Cocaïne</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'éluant')">THC</button>
    </div>
    <div class="btn-row" id="révélateur">
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">UV254</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">UV365</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Marquis-Mandelin</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Dragendorf</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Mecke</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Liebermann</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Marquis</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Mandelin</button>
        <button class="btn-tlc" onclick="selectBtn(this, 'révélateur')">Erhlich</button>
    </div>
    <div class="input-row">
        <label for="echantillons">Échantillons (Liste séparés par des virgules) :</label>
        <input name="echantillons" id="echantillons" placeholder="FEST25001, MDMA, etc...">
    </div>
    <div class="input-area">
        <label for="resultats">Résultats (Lignes de la liste séparés par des virgules) :</label>
        <textarea rows="8" id="resultats" placeholder="MDMA\nMDMA\nMDMA,Caféine"></textarea>
    </div>
    <div class="btn-row" id="action">
        <button class="btn-tlc" onclick="saveData()">Sauvegarder</button>
        <button class="btn-tlc">Passer</button>
    </div>
    {% if last_img %}
        <div style="margin-bottom:30px;">
            <img src="{{ url_for('static', filename='images/' + last_img) }}" alt="Dernière image" style="max-width:400px; border:2px solid #4caf50; box-shadow:2px 2px 12px #aaa;">
            <br><b>{{ last_img }}</b>
        </div>
    {% else %}
        <p>Aucune image détectée.</p>
    {% endif %}
    {% if last_img %}
        <script>
            window.last_img = {{ last_img|tojson|safe }};
        </script>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
    if (document.getElementById('echantillons')) {
        fetch("{{ url_for('static', filename='echantillons.json') }}")
        .then(r => r.json())
        .then(list => {
            const input = document.getElementById('echantillons');
            new Tagify(input, {
                whitelist: list,
                dropdown: {
                    enabled: 1,
                    maxItems: 20,
                    classname: 'tags-look',
                    fuzzySearch: true,
                    highlightFirst: true
                }
            });
        });
    }
    
    // Autocomplétion sur chaque ligne du textarea resultats
    fetch("{{ url_for('static', filename='echantillons.json') }}")
        .then(r => r.json())
        .then(list => {
            const textarea = document.getElementById('resultats');
            if (!textarea) return;
            let currentList = [];
            textarea.addEventListener('input', function(e) {
                const pos = textarea.selectionStart;
                const value = textarea.value;
                const lines = value.substr(0, pos).split(/\r?\n/);
                const currentLineIdx = lines.length - 1;
                const currentLine = lines[currentLineIdx];
                currentList = list.filter(v => v.toLowerCase().startsWith(currentLine.trim().toLowerCase()));
                // Affiche la liste dans la console pour debug
                console.log('Suggestions:', currentList);
            });
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && currentList.length > 0) {
                    e.preventDefault();
                    const pos = textarea.selectionStart;
                    const value = textarea.value;
                    const lines = value.substr(0, pos).split(/\r?\n/);
                    const currentLineIdx = lines.length - 1;
                    const before = lines.slice(0, currentLineIdx).join('\n');
                    const after = value.substr(pos);
                    const completed = currentList[0];
                    lines[currentLineIdx] = completed;
                    const newValue = (before ? before + '\n' : '') + lines[currentLineIdx] + after;
                    textarea.value = newValue;
                    textarea.selectionStart = textarea.selectionEnd = (before ? before.length + 1 : 0) + completed.length;
                }
            });
        });
    </script>
    {% endblock %}
